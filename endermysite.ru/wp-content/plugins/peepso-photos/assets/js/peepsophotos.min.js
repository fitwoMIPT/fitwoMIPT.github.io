!function(a,o){function e(){c(window).on("peepso_activity_deleted",function(e,t,o){t.success&&(c(".photo-item[data-id="+o+"]").remove(),void 0!==t.data.photo_total&&t.data.photo_total<=0&&c(".ps-js-activity--"+t.data.post_act_id).remove())})}var c,m,t;c=a,t=(m=o).photos=new e,e.prototype.set_as_avatar=function(e){var t=jQuery.extend({user_id:peepsodata.userid,photo_id:jQuery("#photoid_tobe_photo_profile").val(),_wpnonce:jQuery("#_photoprofilenonce").val()},e||{});m.postJson("photosajax.set_photo_as_avatar",t,function(e){e.success&&window.location.reload()})},e.prototype.set_as_cover=function(e){var t=jQuery.extend({user_id:peepsodata.userid,photo_id:jQuery("#photoid_tobe_photo_profile").val(),_wpnonce:jQuery("#_photoprofilenonce").val()},e||{});m.postJson("photosajax.set_photo_as_cover",t,function(e){e.success&&window.location.reload()})},e.prototype.arrange_images=_.debounce(function(){var r="photo-container-placeholder",p="ps-js-initialized";c(".ps-js-photos").not("."+p).each(c.proxy(function(e,t){var o,s=c(t),a=s.children(".ps-js-photo"),i=s.children(".ps-js-loading"),n=s.hasClass(r);o=a.map(function(){return c(this).find("img").data("src")}),this.load_images(o).always(c.proxy(function(){i.remove(),a.each(function(){var e=c(this).find("img");e.attr("src",e.data("src")),e.removeData("src").removeAttr("data-src")}),n&&a.each(function(e,t){var o=c(t),s=o.find("img");o.data({width:s[0].naturalWidth,height:s[0].naturalHeight})}),1<a.length&&this._arrange_images(s.width()-4,a),n&&(s.css({opacity:0}).removeClass(r),s.animate({opacity:1})),s.addClass(p)},this))},this))},100),e.prototype.rearrange_images=function(){var e="ps-js-initialized";c(".photo-container").filter("."+e).removeClass(e),this.arrange_images()},e.prototype._arrange_images=function(e,t){var o,s,a,i,n,r,p=180,d=t.length,l=[];for(n=o=0;n<d;n++){for(l[n]=t.eq(n).data(),s=0,r=n;o<=r;r--)s+=l[r].width/l[r].height;if((a=e/s)<=p){for(r=o;r<=n;r++)t.eq(r).css({height:""}).find("img").css({height:a,marginTop:""});o=n+1}else n===d-1&&(i="height: "+a+"px",p<a&&(i+="; margin-top: -"+Math.floor((a-p)/2)+"px !important"),t.eq(o).nextAll().addBack().css({height:p}).find("img").attr("style",i))}},e.prototype.comment_attach_photo=function(e,t){var o,s,a,i,n;o=c(e).closest(".ps-comment-reply,.ps-comment-edit").find(".ps-js-addons"),(n=(s=o.find(".ps-js-addon-photo")).data("initialized"))||(i=c('<input type="file" name="filedata[]" accept=".gif,.jpg,.jpeg,.png,.tif,.tiff" />').uniqueId(),(a=c("<div />").append(i)).css({position:"absolute",top:0,right:0,width:1,height:1,overflow:"hidden"}),a.insertAfter(s),i.psFileupload({formData:{user_id:peepsodata.currentuserid},singleFileUploads:!1,sequentialUploads:!1,replaceFileInput:/^((?!chrome|android).)*safari/i.test(navigator.userAgent),dropZone:o.closest(".ps-textarea-wrapper"),pasteZone:null,dataType:"json",url:peepsodata.ajaxurl_legacy+"photosajax.upload_photo",add:c.proxy(function(e,t){this.validate_photo(t)},this),submit:function(){return s.find(".ps-js-remove").hide(),s.find(".ps-js-loading").show(),s.find(".ps-js-img").hide(),s.show(),c(document).trigger("ps_comment_addon_added",s),!0},done:c.proxy(function(e,t){var o=t.result;o.success&&(s.find(".ps-js-remove").show(),s.find(".ps-js-loading").hide(),s.find(".ps-js-img").attr("src",o.data.thumbs[0]).data("id",o.data.files[0]).show(),c(document).trigger("ps_comment_addon_added",s))},this)}),n=i.attr("id"),s.data("initialized",n)),t instanceof FileList||m.isWebdriver()||c("#"+n).trigger("click")},e.prototype.validate_photo=function(t){for(var e,o=/\.(gif|jpg|jpeg|png|tif|tiff)$/i,s=0,a=0;a<t.files.length;a++){if(e=t.files[a],!o.test(e.name))return psmessage.show("",peepsophotosdata.error_unsupported_format).fade_out(psmessage.fade_time),!1;s+=parseInt(e.size)}var i={size:s,filesize:s,photos:t.files.length};i=m.observer.applyFilters("photos_validate_req",i);m.postJson("photosajax.validate_photo_upload",i,function(e){e.success?t.submit():psmessage.show("",e.errors[0]).fade_out(psmessage.fade_time)})},e.prototype.show_dialog_album=function(e){new m.PhotoAlbumDialog(e)},e.prototype.show_dialog_add_photos=function(e,t){new m.PhotoAlbumUploadDialog(e,t)},e.prototype.show_dialog_delete_album=function(e,t,o){var s=jQuery.extend({album_id:t,uid:e,_wpnonce:jQuery("#_delete_album_nonce").val()},o||{}),a=jQuery("[data-album-delete-id="+t+"]"),i="";return 0<a.size()&&(i=a.text()),pswindow.confirm_delete(function(){s=m.observer.applyFilters("photos_delete_album",s),m.postJson("photosajax.delete_album",s,function(e){e.success?window.location.reload():psmessage.show("",e.errors[0]).fade_out(psmessage.fade_time)})},i),!1},e.prototype.delete_stream_album=function(e,t){var o={post_id:e,uid:peepsodata.currentuserid},s=jQuery("[data-act-delete-id="+t+"]"),a="";return 0<s.size()&&(a=s.text()),pswindow.confirm_delete(function(){o=m.observer.applyFilters("photos_delete_stream_album",o),m.postJson("photosajax.delete_stream_album",o,function(e){e.success?window.location.reload():psmessage.show("",e.errors[0]).fade_out(psmessage.fade_time)})},a),!1},e.prototype.select_menu=function(e){var t=c(e.options[e.selectedIndex]),o=t.val(),s=t.data("url");(window.location+"").match(/\/requests/)&&s.match(/\/requests/)?c(".ps-js-photos-submenu").siblings(".tab-content").find("album"===o?"#album":"#latest").addClass("active").siblings().removeClass("active"):window.location=t.data("url")},e.prototype.load_image=function(a){return c.Deferred(function(e){var t=new Image;function o(){s(),e.reject(t)}function s(){t.onload=null,t.onerror=null,t.onabort=null}t.onload=function(){s(),e.resolve(t)},t.onerror=o,t.onabort=o,t.src=a}).promise()},e.prototype.load_images=function(e){var t,o=[];for("object"==typeof e&&"number"==typeof e.length||(e=[e]),t=0;t<e.length;t++)o.push(this.load_image(e[t]));return c.when.apply(c,o)},e.prototype.show_image=function(e){var t="ps-js-photo-popup",p=/\.gif/i,d=/\.jpe?g/i;if(/\.(gif|jpe?g|png)/i.test(e)){var o=c("."+t).eq(0);o.length||((o=c(peepsophotosdata.template_popup)).addClass(t).appendTo(document.body),o.on("click",".ps-lightbox-padding, .ps-lightbox-close",function(e){c(e.currentTarget).closest(".ps-lightbox").hide()}),o.on("click",".ps-lightbox-wrapper",function(e){e.stopPropagation()}),o.on("click",".ps-lightbox-play",function(e){var t=c(e.currentTarget),o=t.siblings(".ps-js-img").find("img"),s="ps-icon-play",a="ps-icon-stop",i=o.attr("src"),n=t.data("played"),r=t.data("timer-stop");n?(t.removeData("played"),t.removeClass(a).addClass(s),o.attr("src",i.replace(p,".jpg")),t.removeData("timer-stop"),clearTimeout(r)):(t.data("played",1),t.removeClass(s).addClass(a),o.attr("src",i.replace(d,".gif")),m.browser.isTouch()&&(clearTimeout(r),r=setTimeout(function(){t.removeClass(a)},1e3),t.data("timer-stop",r),o.one("click",function(){t.click()})))}));var s=o.find(".ps-js-img");p.test(e)?(e=e.replace(p,".jpg"),s.html('<img src="'+e+'" />'),s.next(".ps-lightbox-play").removeClass("ps-icon-stop").addClass("ps-icon-play").show()):(s.html('<img src="'+e+'" />'),s.next(".ps-lightbox-play").hide()),o.show()}},c(document).ready(function(){c(window).on("load",function(){t.arrange_images()}),m.observer.addAction("browser.resize",function(){t.rearrange_images()}),c(document).on("ps_activitystream_loaded ps_activitystream_append peepso_repost_shown peepso_report_shown peepso_repost_added peepso_post_edit_saved peepso_messages_list_displayed ps_comment_added",function(e){"ps_activitystream_append"===e.type?setTimeout(function(){t.arrange_images()},3e3):t.arrange_images(),pswindow.is_visible&&pswindow.refresh()}),c(document).on("ps_comment_aftersave",function(e,t,o){var s=c(o).closest(".ps-comment-reply,.ps-comment-edit").find(".ps-js-addon-photo");s.find(".ps-js-remove").hide(),s.find(".ps-js-loading").hide(),s.find(".ps-js-img").attr("src","").removeData("id").hide(),s.hide(),c(document).trigger("ps_comment_addon_removed",s)}),c(document).on("ps_comment_save ps_lightbox_navigate",function(){t.arrange_images()}),c(document).on("click",".ps-js-addon-photo .ps-js-remove",function(){var e=c(this).closest(".ps-js-addon-photo"),t=e.find(".ps-js-img"),o=t.data("id");e.find(".ps-js-remove").hide(),e.find(".ps-js-loading").hide(),t.attr("src","").removeData("id").removeAttr("data-id").hide(),e.hide();var s={user_id:peepsodata.currentuserid,photo:[o],_wpnonce:e.find("[name=_wpnonce_remove_temp_comment_photos]").val(),_wp_http_referer:e.find("[name=_wp_http_referer]").val()};s=m.observer.applyFilters("photos_remove_temp_files",s),m.postJson("photosajax.remove_temp_files",s),c(document).trigger("ps_comment_addon_removed",e)}),m.observer.addAction("comment_edit",function(e,t){var o=c(t).find(".ps-js-addon-photo"),s=o.find(".ps-js-img");s.length&&s.data("id")?(o.find(".ps-js-remove").show(),o.find(".ps-js-loading").hide(),o.find(".ps-js-img").show(),o.show(),c(document).trigger("ps_comment_addon_added",o)):(o.find(".ps-js-remove").hide(),o.find(".ps-js-loading").hide(),o.find(".ps-js-img").hide(),o.hide(),c(document).trigger("ps_comment_addon_removed",o))},10,2),c(document).on("click",".ps-lightbox .ps-js-btn-gif",function(e){var t,o,s=c(e.currentTarget),a=s.siblings(".ps-js-photo-gif"),i="ps-icon-play",n="ps-icon-stop",r="ps-icon-spinner",p=a.attr("src"),d=s.data("played"),l=s.data("timer-stop");if(e.preventDefault(),e.stopPropagation(),d)return s.removeData("played"),s.removeClass(n).addClass(i),a.attr("src",p.replace(".gif",".jpg")),s.removeData("timer-stop"),void clearTimeout(l);t=setTimeout(function(){s.addClass(r).removeClass(i)},500),p=p.replace(".jpg",".gif"),(o=new Image).onload=function(){s.data("played",1),s.removeClass(i).removeClass(r),s.addClass(n),a.attr("src",p),clearTimeout(t),m.browser.isTouch()&&(clearTimeout(l),l=setTimeout(function(){s.removeClass(n)},1e3),s.data("timer-stop",l),a.one("click",function(){s.click()}))},o.src=p})}),m.observer.addFilter("ps_photos_available",function(e){return!0},10,1),m.observer.addFilter("comment_req",function(e,t){var o,s=c(t).closest(".ps-comment-reply,.ps-comment-edit").find(".ps-js-addon-photo");return s.is(":visible")&&(o=s.find(".ps-js-img")).length&&o.data("id")&&(e.photo=o.data("id")),e},10,2),m.observer.addFilter("comment_can_submit",function(e){var t,o=c(e.el).closest(".ps-comment-reply,.ps-comment-edit").find(".ps-js-addon-photo");return o.is(":visible")&&(t=o.find(".ps-js-img")).length&&t.data("id")&&(e.can_submit=!0),e},10,1),m.observer.addFilter("comment_show_button",function(e){var t,o=c(e.el).closest(".ps-comment-reply,.ps-comment-edit").find(".ps-js-addon-photo");return o.is(":visible")&&(t=o.find(".ps-js-img")).length&&t.data("id")&&(e.show=!0),e},10,1),o.observer.addAction("peepso_delete_post",function(e){var t=a(".ps-widget--photos").find(".ps-js-photo");(t=t.filter('[data-post-id="'+e+'"]')).remove()},10,1),o.observer.addAction("commentbox_drop_files",function(e,t){o.photos.comment_attach_photo(e,t)},10,2),o.observer.addFilter("human_friendly_extras",function(e,t,o){if(!t&&o&&!o.querySelector(".ps-stream-header")){var s=a(o).find(".ps-comment-media .ps-media-photos [data-preview]");s.length&&e.push(s.data("preview"))}return e},20,3)}(jQuery||$,peepso);