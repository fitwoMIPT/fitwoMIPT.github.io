!function(e,t){ps_messages=t.messages=function(u,g){function e(){this.$recipient_select=null;this.query="";this.page={inbox:1,sent:1};this.ajax_req=false;this.enter_to_send=false;this.unread=undefined}var m=new e,p={};function l(e,t){var s=t(e.display_name),n=t(e.avatar||p[e.id]||"");return'<div><img src="'+n+'" /><span>'+s+"</span></div>"}function d(e,t){var s=t(e.display_name),n=t(e.avatar||p[e.id]||"");return'<div><img src="'+n+'" /><span>'+s+"</span></div>"}return e.prototype.init_conversation_view=function(n){u("#add-recipients-toggle").on("click",function(e){e.preventDefault(),u(".ps-js-recipients").slideToggle()}),u("#recipients-search").selectize({valueField:"id",labelField:"display_name",searchField:"display_name",plugins:["remove_button"],closeAfterSelect:!0,render:{option:d,item:l},load:function(e,s){g.postJson("messagesajax.get_available_recipients",{parent_id:n,keyword:e},function(e){var t;e.success&&(t=e.data.available_participants||[],u.each(t,function(e,t){p[t.id]=t.avatar})),s(t)})},onInitialize:function(){var e='<img src="'+this.$input.data("loading")+'" />';this.$wrapper.append(e),this.$control_input.on("input",function(e){var t=u(this);setTimeout(function(){t.trigger("keyup")},0)})}}),this.$postbox=u("div#postbox-message").pspostbox({text_length:peepsomessagesdata.character_limit,send_button_text:peepsomessagesdata.send_button_text,save_url:"messagesajax.add_message",postbox_req:function(e){return m.saving=!0,e.parent_id=n,e},on_before_save:function(){u(".ps-postbox-input:visible textarea").val("")},on_save:function(e){m.polling||(m.polling=!0,m.load_next_in_conversation(n,"new"))},on_queue_clear:function(){m.saving=!1,m.$postbox.$posttabs.on_cancel()}}),this.$postbox.$textarea.on("focus click",_.throttle(function(){g.disableAuth().disableError().postJson("messagesajax.mark_read_messages_in_conversation",{msg_id:n})},2e3)),g.observer.addFilter("peepso_postbox_enter_to_send",function(){return m.enter_to_send}),g.observer.addFilter("peepso_postbox_input_changed",function(e){m.currently_typing()}),m.$conversation=u(".ps-chat__messages"),m.$loading=u(".ps-js-loading",m.$conversation),m.$typing=u(".ps-js-currently-typing",m.$conversation),m.$entersend=u(".ps-js-checkbox-entertosend"),m.$doc=u(document),m.$conversation.data({conversation_id:n}),m.$conversation.length&&(m.$conversation.css({maxHeight:"60vh",overflow:"auto"}).off("scroll").on("scroll",m.on_conversation_scroll).bind("mousewheel",function(e,t){var s=u(e.currentTarget);0<t&&0===s.scrollTop()?e.preventDefault():t<0&&s.scrollTop()==s.get(0).scrollHeight-s.innerHeight()&&e.preventDefault()}),m.polling=!0,m.load_next_in_conversation(n),m.init_long_polling(1500)),m.enter_to_send=m.$entersend[0].checked,m.$entersend.on("click",m.toggle_entertosend),g.observer.addFilter("psmessages_conversation_view",function(){return!0}),g.observer.addFilter("psmessages_conversation_mute",function(e){var t;return+e==+n&&((t=u(".ps-js-btn-mute-conversation")).attr("onclick","return ps_messages.unmute_conversation("+e+", 0);"),t.attr("title",peepsomessagesdata.unmute_conversation),t.find("i").attr("class","ps-icon-bell-off")),e},10,1),g.observer.addFilter("psmessages_conversation_unmute",function(e){var t;return+e==+n&&((t=u(".ps-js-btn-mute-conversation")).attr("onclick","return ps_messages.mute_conversation("+e+", 1);"),t.attr("title",peepsomessagesdata.mute_conversation),t.find("i").attr("class","ps-icon-bell-alt")),e},10,1),u(".ps-js-btn-blockuser").on("click",function(e){if(confirm(peepsomessagesdata.blockuser_confirm_text)){var t=u(e.currentTarget).data("user-id");ps_member.block_user(t)}})},e.prototype.load_next_in_conversation=function(l,d){return u.Deferred(u.proxy(function(p){var e,t={msg_id:l},s=Math.floor((new Date).getTime()/1e3);"new"===d?(e=m.$conversation.find(".ps-js-message").last(),t.from_id=e.data("id"),t.direction=d,t.get_unread=1):"old"===d?(e=m.$conversation.find(".ps-js-message").first(),m.$loading.show(),t.from_id=e.data("id"),t.direction=d):m.$loading.show(),(!this.lastOnlineCheck||this.lastOnlineCheck<s-60)&&(this.lastOnlineCheck=s,t.get_participants=1),g.disableAuth().disableError().postJson("messagesajax.get_messages_in_conversation",t,function(t){var e,s,n,a;if("old"===d?setTimeout(function(){var e;m.$loading.hide(),t.success&&t.data.ids&&t.data.ids.length&&(m.$conversation.stop(),e=m.$loading.next(),a=u("<div />").append(t.data.html),a=g.observer.applyFilters("messages_render",a),g.observer.doAction("peepso_external_link",a),a.insertAfter(m.$loading),m.$conversation.stop().scrollTop(Math.max(0,e.position().top-131)),m.$doc.trigger("peepso_messages_list_displayed"),m.$conversation.off("scroll").on("scroll",m.on_conversation_scroll))},1e3):("new"===d||m.$loading.hide(),m.polling=!1,t.success&&(m.submit_entertosend||m.toggle_entertosend(+t.data.enter_to_send),t.data.ids&&t.data.ids.length&&(a=u("<div />").append(t.data.html),a=g.observer.applyFilters("messages_render",a),g.observer.doAction("peepso_external_link",a),a.insertBefore(m.$typing),m.$doc.trigger("peepso_messages_list_displayed"),e=s=!0))),t.success&&t.data&&(!t.data.currently_typing||s?m.$typing.empty():(m.$typing.html(t.data.currently_typing),e=!0)),t.data&&t.data.users){n=!1;for(var i=0;i<t.data.users.length;i++)if(+t.data.users[i].online){n=!0;break}u(".ps-conversation__status").children().get(0).className=n?"ps-icon-circle":"ps-icon-clock"}if(t.data&&void 0!==t.data.receipt){var o=+t.data.receipt,r=+t.data.unread;m.receipt===o&&m.unread===r||(m.receipt=o,m.unread=r,o&&m.toggle_message_checkmark(r))}if(t.data&&void 0!==t.data.send_receipt){var c=+t.data.send_receipt;m.send_receipt!==c&&(m.send_receipt=c,m.update_checkmark(l,c))}e&&m.conversation_scroll2bottom(),p.resolve(!!s)})},this))},e.prototype.on_conversation_scroll=_.debounce(function(){m.$conversation[0].scrollTop<=10&&(m.$conversation.off("scroll"),m.load_next_in_conversation(m.$conversation.data("conversation_id"),"old"))},200),e.prototype.conversation_scroll2bottom=function(){m.$conversation.stop().scrollTop(m.$conversation[0].scrollHeight)},e.prototype.init_long_polling=function(e){this.smart_long_polling()},e.prototype.smart_long_polling=function(e){var s=this.$conversation.data("conversation_id"),t=+peepsodata.notification_ajax_delay_min,n=+peepsodata.notification_ajax_delay,a=+peepsodata.notification_ajax_delay_multiplier,i=Math.max(e||0,t),o=u.proxy(function(t){clearTimeout(this.pollingTimer),this.pollingTimer=setTimeout(u.proxy(function(){this.load_next_in_conversation(s,"new").done(function(e){t=e?i:Math.min(t*a,n),o(t)})},this),t)},this);o(i),g.observer.addAction("browser.inactive",function(){o(n)}),g.observer.addAction("browser.active",function(){o(t)})},e.prototype.currently_typing=_.throttle(function(){g.disableAuth().disableError().postJson("messagesajax.i_am_typing",{msg_id:m.$conversation.data("conversation_id")})},+peepsodata.notification_ajax_delay_min||5e3),e.prototype.toggle_entertosend=function(e){var t=m.$entersend[0],s=+e,n=!1;e&&e.target&&(n=!0,s=+e.target.checked,m.submit_entertosend=!0,g.disableAuth().disableError().postJson("messagesajax.enter_to_send",{enter_to_send:s},function(){m.submit_entertosend=!1})),!n&&s===+t.checked||(t.checked=m.enter_to_send=!!s,m.$postbox.on_change())},e.prototype.new_message=function(a,s,e){if(window.ps_chat&&"large"===g.screenSize()&&e){var t=(e=u(e)).find("img").css("display","inline");g.postJson("chatajax.get_chat_with",{recipient:a},function(e){e.success&&ps_chat.open_chat(e.data.msg_id),setTimeout(function(){t.hide()},1e3)})}else{var n,i=this,o=u("<div />").append(peepsomessagesdata.template),r=pswindow.show(o.find(".dialog-title").html(),o.find(".dialog-content").html()).$container.find(".ps-dialog");g.observer.addAction("pswindow_before_close",n=function(e){g.observer.removeAction("pswindow_before_close",n),g.observer.doAction("psmessage_new_message_close",e)},10,1),r.addClass("ps-dialog-wide"),g.observer.addFilter("pswindow_close",function(){r.removeClass("ps-dialog-wide")},10,1);var c=this.$message_postbox=u("#cWindowContent div.ps-postbox-message").pspostbox({autosize:!1,text_length:peepsomessagesdata.character_limit,save_url:"messagesajax.new_message",send_button_text:peepsomessagesdata.send_button_text,postbox_req:function(e){return{subject:"",message:e.content,recipients:i.$recipient_select.val()}},on_save:function(e){pswindow.hide().show("",e.notices[0]).fade_out(pswindow.fade_time),g.observer.removeFilter("beforeunload",c.beforeUnloadHandler),u(window).trigger("peepso_messages_after_send",[e])},on_error:function(e){alert(e.errors[0])}});this.$recipient_single=u("#ps-window .ps-js-recipient-single").hide(),this.$recipient_multiple=u("#ps-window .ps-js-recipient-multiple").hide(),this.$recipient_select=u("select[name=recipients]",this.$recipient_multiple),this.get_available_recipients(a,u.proxy(function(e){var n,t;!e instanceof Array&&(e=[]),s&&(t=e.filter(function(e){return e[s]})).length&&(e=t),u.each(e,function(e,t){p[t.id]=t.avatar;var s=u("<option/>").val(t.id).text(t.display_name);i.$recipient_select.append(s),a===parseInt(t.id)&&(s.attr("selected","selected"),n=t)}),void 0!==a?(u("option[value!="+a+"]",this.$recipient_select).remove(),n&&(this.$recipient_single.find("img").attr("src",n.avatar).attr("alt",n.display_name),this.$recipient_single.find(".ps-comment-user").html(n.display_name),this.$recipient_single.find("a").attr("href",n.url),this.$recipient_single.show())):(this.$recipient_multiple.show(),this.$recipient_select.selectize({valueField:"id",labelField:"display_name",searchField:"display_name",plugins:["remove_button"],closeAfterSelect:!0,render:{option:d,item:l},load:function(e,s){g.postJson("messagesajax.get_available_recipients",{keyword:e},function(e){var t;e.success&&(t=e.data.available_participants||[],u.each(t,function(e,t){p[t.id]=t.avatar})),s(t)})},onInitialize:function(){var e='<img src="'+this.$input.data("loading")+'" />';this.$wrapper.append(e),this.$control_input.on("input",function(e){var t=u(this);setTimeout(function(){t.trigger("keyup")},0)})},onChange:function(e){i.toggle_send_button(),this.$control_input.blur()}})),this.toggle_send_button()},this))}},e.prototype.compact_map=function(e){0<e.closest(".ps-dialog").length&&e.find(".ps-postbox-location").addClass("ps-postbox-location-compact")},e.prototype.get_available_recipients=function(t,s){if(t&&this.available_recipients&&this.available_recipients[t])s(this.available_recipients[t]);else{var n=u("#ps-window .ps-js-recipient-loading").show();g.postJson("messagesajax.get_available_recipients",{user_id:t},u.proxy(function(e){n.hide(),e.success?(this.available_recipients=this.available_recipients||{},this.available_recipients[t]=e.data.available_participants,s(this.available_recipients[t])):s([])},this))}},e.prototype.toggle_send_button=function(){this.$recipient_select.val()?this.$message_postbox.$save_button._detached&&(this.$message_postbox.$save_button.appendTo(this.$message_postbox.$save_button._detached),this.$message_postbox.$save_button._detached=!1):(this.$message_postbox.$save_button._detached=this.$message_postbox.$save_button.parent(),this.$message_postbox.$save_button.detach())},e.prototype.add_recipients=function(e){var t={parent_id:e,participants:u("#recipients-search").val(),add_participant_nonce:u("input[name='add-participant-nonce']").val()},s=u(".ps-js-recipients .ps-btn-success"),n=s.find("img");s.attr("disabled","disabled"),n.show(),g.postJson("messagesajax.add_participants",t,function(e){if(e.success){if(e.data.new_conversation_redirect)return void(window.location=e.data.new_conversation_redirect);n.hide(),s.removeAttr("disabled"),u(".ps-js-participant-summary").html(e.data.summary),pswindow.show("",e.notices[0]),u("#recipients-search option").remove(),u.each(e.data.available_participants,function(e,t){option=u("<option/>").val(t.id).text(t.display_name),u("#recipients-search").append(option)}),u("#recipients-search").trigger("chosen:updated"),u(".ps-js-recipients").slideToggle()}else n.hide(),s.removeAttr("disabled")})},e.prototype.toggle_checkboxes=function(e){var t=u(e);t.parents(".ps-messages").find("input[type='checkbox']").prop("checked",t.prop("checked"))},e.prototype.load_messages=function(s,n,a){var i=this,e={type:s,page:n,per_page:peepsomessagesdata.per_page,query:a},o=u("#"+s);u(".ps-js-loading",o).show(),g.postJson("messagesajax.get_messages",e,function(t){u(".ps-js-loading",o).hide(),t.success&&($messages=u(t.data.html),$messages.hide(),o.html($messages),$messages.fadeIn("slow").one("click",".ps-js-prev",function(e){e.preventDefault(),--n<=0?n++:i.load_messages(s,n,a)}).one("click",".ps-js-next",function(e){e.preventDefault(),++n>t.data.total_pages?n--:i.load_messages(s,n,a)}).on("click",".ps-js-bulk-actions",function(e){i.apply_bulk_action(e.target,s,n)}),u($messages,".ps-js-messages-search-form").on("submit",function(){$query=u("input[name='query']",this),i.load_messages(s,1,$query.val())}),u(document).trigger("peepso_messages_list_displayed"))})},e.prototype.apply_bulk_action=function(e,t,s){var n=u(e).closest("form"),a=n.serialize(),i=this;0<u("#peepso-wrap .ps-message--inbox input:checked").length?""===n.find("select[name='action']").val()?psmessage.show("",u("#peepsomessages-no-action-selected").html()):!1===this.ajax_req&&("delete"===n.find("select[name='action']").val()?pswindow.confirm_delete(function(){i._bulk_action(a,t,s),pswindow.hide()}):this.ajax_req=this._bulk_action(a,t,s)):psmessage.show("",u("#peepsomessages-no-item-selected").html())},e.prototype._bulk_action=function(e,t,s){var n=this;return g.postJson("messagesajax.bulk_action",e,function(){n.ajax_req=!1,m.load_messages(t,s)}),!0},e.prototype.show_long_participants=function(){u("#summary-participants").hide(),u("#long-participants").fadeIn()},e.prototype.delete_single_message=function(t){return pswindow.confirm_delete(function(){pswindow.hide(),g.postJson("messagesajax.delete_from_conversation",{msg_id:t},function(e){e.success&&u(".ps-js-message-"+t).remove()})}),!1},e.prototype.open_image=function(e){g.lightbox([{content:'<div style="display:inline-block;"><img src="'+e+'" /></div>'}],{simple:!0})},e.prototype.toggle_checkmark=function(t,s){return m.update_checkmark(t,s),g.disableAuth().disableError().postJson("messagesajax.set_message_read_notification",{msg_id:t,read_notif:+s},function(e){e.success&&s&&g.disableAuth().disableError().postJson("messagesajax.mark_read_messages_in_conversation",{msg_id:t})}),!1},e.prototype.update_checkmark=function(e,t){u(".ps-chat__messages");var s=u(".ps-js-btn-toggle-checkmark");s.find("i");t?(s.attr("onclick","return ps_messages.toggle_checkmark("+e+", 0);"),s.attr("title",peepsomessagesdata.hide_checkmark),s.removeClass("disabled")):(s.attr("onclick","return ps_messages.toggle_checkmark("+e+", 1);"),s.attr("title",peepsomessagesdata.show_checkmark),s.addClass("disabled"))},e.prototype.toggle_message_checkmark=_.throttle(function(e){u(".ps-chat__messages");var t=u(".ps-chat__messages").find(".ps-icon-ok");t.addClass("read"),0<e&&t.slice(0-e).removeClass("read")},1e3),e.prototype.mute_conversation=function(e){var t=peepsomessagesdata.mute_confirm.replace("{msg_id}",e);return pswindow.show(peepsomessagesdata.mute_conversation,t),!1},e.prototype.confirm_mute_conversation=function(t,e){var s;return pswindow.hide(),s=(e=u(e)).closest("form").find("input[type=radio]:checked").val(),g.postJson("messagesajax.set_mute",{parent_id:t,mute:s},function(e){e.success&&g.observer.applyFilters("psmessages_conversation_mute",t)}),!1},e.prototype.unmute_conversation=function(t){return g.postJson("messagesajax.set_mute",{parent_id:t,mute:0},function(e){e.success&&g.observer.applyFilters("psmessages_conversation_unmute",t)}),!1},e.prototype.leave_conversation=function(e,t){return pswindow.confirm(e,function(){window.location=u(t).attr("href")}),!1},u(function(){var t="inbox";u("#messages-tab a[data-toggle='tab']").on("click",function(e){t=u(u(this).attr("href")).attr("id"),m.load_messages(t,1)}),u(window).on("peepso_messages_after_send",function(e,t){window.location=t.data.url});var s=u(".ps-js-messages-notification").psnotification({view_all_link:peepsomessagesdata.messages_page,source:"messagesajax.get_latest",before_click:function(){var e;return!(!window.ps_chat||"large"!==g.screenSize())||!!((e=s.find(".ps-js-counter")).length&&0<+e.eq(0).text())}}).on("notifications.shown",function(e,t){var s=".ps-notification__wrapper > .ps-messages-item";window.ps_chat&&"large"===g.screenSize()?t.popover_list.find(s).on("click",function(){ps_chat.open_chat(u(this).data("id"))}):u(document.body).hasClass("wp-admin")?t.popover_list.find(s).on("click",function(){var e=u(this).data("url");window.open(e)}):t.popover_list.find(s).one("click",function(){var e=u(this).data("url");window.location=e})})}),m}(e,t)}(jQuery||$,peepso);