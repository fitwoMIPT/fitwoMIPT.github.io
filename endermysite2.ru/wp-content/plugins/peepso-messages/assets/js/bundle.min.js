!function a(o,h,d){function r(e,t){if(!h[e]){if(!o[e]){var s="function"==typeof require&&require;if(!t&&s)return s(e,!0);if(c)return c(e,!0);var i=new Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}var n=h[e]={exports:{}};o[e][0].call(n.exports,function(t){return r(o[e][1][t]||t)},n,n.exports,a,o,h,d)}return h[e].exports}for(var c="function"==typeof require&&require,t=0;t<d.length;t++)r(d[t]);return r}({1:[function(t,e,s){"use strict";var i,n,a;i=jQuery,n=_,a=peepso,window.PsChatInput=function(h,t,d){function e(){this.create()}return d.npm.objectAssign(e.prototype,d.npm.EventEmitter.prototype,{template:peepsochatdata.windowInputTemplate,create:function(){this.$el=h(this.template),this.$textarea=this.$el.find("textarea"),this.$textarea.on("keydown",h.proxy(this.onKeyDown,this)),this.$textarea.on("input",h.proxy(this.onInput,this)),this.$textarea.on("click",h.proxy(this.onClick,this)),this.$textarea.on("focus",h.proxy(this.onFocus,this)),this.$textarea.on("blur",h.proxy(this.onBlur,this)),window.peepsophotosdata&&(this.$el.addClass("ps-chat-with-photo"),this.$upload=this.$el.find(".ps-icon-camera").show(),this.$file=this.$el.find("input[type=file]"),this.$upload.on("click",h.proxy(this.onUploadPhoto,this)),this.uploadPhotoInit())},focus:function(){this.$textarea.focus()},uploadPhotoInit:function(){var e,t=h(document),s="ps-chat-drop-intercept";t.data(s)||(t.data(s,1),t.bind("drop dragover",function(t){h(t.target).closest(".ps-chat-window").length&&t.preventDefault()})),this.$file.psFileupload({formData:{user_id:peepsodata.currentuserid},singleFileUploads:!1,sequentialUploads:!1,replaceFileInput:!1,pasteZone:null,dropZone:this.$el,dataType:"json",url:peepsodata.ajaxurl_legacy+"photosajax.upload_photo",add:h.proxy(function(t,e){this.validatePhoto(e)},this),done:h.proxy(function(t,e){var s=e.result;s.success&&this.emit("submit","",{type:"photo","files[]":s.data.files})},this)}),e=setInterval(h.proxy(function(){var t=this.$el.parent();t&&(clearInterval(e),this.$file.psFileupload("option","dropZone",t.add(t.prev())))},this),1e3)},uploadPhoto:function(){this.$file.trigger("click")},validatePhoto:function(e){for(var t,s=0,i=0;i<e.files.length;i++){if(t=e.files[i],!/\.(gif|jpg|jpeg|tiff|png)$/i.test(t.name))return psmessage.show("",h("#photo-supported-format").text()).fade_out(psmessage.fade_time),!1;s+=parseInt(t.size)}var n={size:s,filesize:s,photos:e.files.length},a=(new Date).getTime()+Math.floor(1e3*Math.random());this.emit("photos_added",e.files.length,a);var o=this;d.postJson("photosajax.validate_photo_upload",n,function(t){t.success?e.submit():(o.emit("photos_cancel",a),psmessage.show("",t.errors[0]).fade_out(psmessage.fade_time))})},onKeyDown:function(t){13!==t.keyCode||t.shiftKey||(t.preventDefault(),t.stopPropagation(),this.emit("submit",h.trim(t.target.value)),this.$textarea.val(""),this.autosize())},onInput:function(t){this.autosize(),this.emit("change",t.target.value)},onClick:function(t){this.emit("click",t)},onFocus:function(t){this.emit("focus",t)},onBlur:function(t){this.emit("blur",t)},onUploadPhoto:function(){this.uploadPhoto()},autosize:t.debounce(function(){this.$textarea[0].style.height="",this.$textarea[0].style.height=Math.min(+this.$textarea[0].scrollHeight,100)+"px"},1)}),e}(i,n,a)},{}],2:[function(t,e,o){(function(t){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.default=a;var d=e("undefined"!=typeof window?window.jQuery:void 0!==t?t.jQuery:null),s=e("undefined"!=typeof window?window._:void 0!==t?t._:null),n=e("undefined"!=typeof window?window.peepso:void 0!==t?t.peepso:null);function e(t){return t&&t.__esModule?t:{default:t}}var i="ps-chat-sidebar-open";function a(){this.ids=[],this.create()}n.default.npm.objectAssign(a.prototype,n.default.npm.EventEmitter.prototype,{template:peepsochatdata.sidebarTemplate,itemTemplate:peepsochatdata.sidebarItemTemplate,translations:peepsochatdata.translations,create:function(){this.$el=(0,d.default)(this.template).hide(),this.$items=this.$el.find(".ps-chat-sidebar-items"),this.$notif=this.$el.find(".ps-chat-sidebar-label .ps-chat-sidebar-notif"),this.$label=this.$el.find(".ps-chat-sidebar-label").find("span"),this.visible=!1,this.$el.on("click",d.default.proxy(this.onToggle,this)),this.$el.on("click",".ps-chat-sidebar-item",d.default.proxy(this.onSelect,this)),this.$el.on("click",".ps-chat-close",d.default.proxy(this.onRemove,this))},isExpanded:function(){return this.$el.hasClass(i)},expand:function(){this.$el.addClass(i),this.emit("expand")},collapse:function(){this.$el.removeClass(i),this.emit("collapse")},toggle:function(){this.isExpanded()?this.collapse():this.expand()},reset:function(t,e){t=t||[],this.remove(s.default.difference(this.ids,t)),this.add(t),this.updateNotification(e)},add:function(t,e){var s,i,n,a;if(t&&t.length){for(a=0;a<t.length;a++)i=+t[a],-1===(n=this.ids.indexOf(i))&&((s=(0,d.default)(this.itemTemplate.replace(/\{id\}/g,i))).appendTo(this.$items),this.ids.push(i),this.update(i,s));for(a=0;a<t.length;a++)i=+t[a],a!==(n=this.ids.indexOf(i))&&(s=this.$items.children("[data-id="+i+"]"),this.ids.splice(n,1),this.ids.splice(a,0,i),0===a?s.prependTo(this.$items):s.insertBefore(this.$items.children().eq(a)));this.ids.length&&!this.visible&&(this.$el.show(),this.visible=!0),e&&this.emit("add",t),this.updateCounter()}},remove:function(t,e){var s,i,n;if(t&&t.length){for(n=0;n<t.length;n++)s=+t[n],0<=(i=this.ids.indexOf(s))&&(this.$items.children("[data-id="+s+"]").remove(),this.ids.splice(i,1));!this.ids.length&&this.visible&&(this.$el.hide(),this.visible=!1),e&&this.emit("remove",t),this.updateCounter()}},removeFirst:function(){if(this.ids.length){var t=this.ids[0];return this.remove([t]),t}},select:function(t){this.emit("select",+t)},update:function(o,t){var s=this;if(this.captions=this.captions||{},(t=t||this.$items.children("[data-id="+o+"]")).length){var i=t.find(".ps-js-caption"),h=this.captions[o];if(h)return i.find("img").attr("src",h.avatar),void i.find("span").html(h.name);if(i.data("deferCaption"))return;i.data("deferCaption",1);var e=function(){var t=n.default.disableAuth().disableError(),e={msg_id:o,chat:1,get_participants:1,get_messages:0};s.fetchQueue=s.fetchQueue||[],s.fetchQueueCounter=s.fetchQueueCounter||0,s.fetchQueueExec=s.fetchQueueExec||d.default.proxy(function(){var s=this;if(!(5<=this.fetchQueueCounter)&&this.fetchQueue.length){this.fetchQueueCounter++;var t=this.fetchQueue.shift(),e=t.transport,i=t.action,n=t.params,a=t.$caption;e.postJson(i,n,function(t){if(t.success){var e=t.data.users;e&&e.length&&(s.captions[o]=h={avatar:1===e.length?e[0].avatar:"",name:s.formatParticipants(e)},a.find("img").attr("src",h.avatar),a.find("span").html(h.name))}s.fetchQueueCounter--,s.fetchQueueExec()})}},s),s.fetchQueue.push({transport:t,action:"messagesajax.get_messages_in_conversation",params:e,$caption:i}),setTimeout(function(){return s.fetchQueueExec()},500)};this.isExpanded()?e():this.once("expand",function(){e()})}},updateCounter:s.default.debounce(function(){this.counter||(this.counter=0),this.ids.length!==this.counter&&(this.counter=this.ids.length,this.$label.html(this.counter))},400),updateNotification:s.default.debounce(function(t){var e,s,i=0,n=!1;for(s in this.notifState||(this.notifState={}),t)-1!==this.ids.indexOf(+s)&&t[s]!==this.notifState[s]&&(n=!0,this.notifState[s]=t[s],e=this.$items.find(".ps-chat-sidebar-item-"+s).find(".ps-chat-sidebar-notif"),t[s]?(e.show(),i++):e.hide());n&&(i?this.$notif.html(i).show():this.$notif.hide())},400),formatParticipants:function(t){var e="&nbsp;";if(1===t.length)e=t[0].name_full;else if(1<t.length){e=[];for(var s=0,i=Math.min(2,t.length-1);s<i;s++)e.push(t[s].name_first);e=e.join(", "),e=2===t.length?this.translations.and.replace(/%s(.+)%s/,e+"$1"+t[t.length-1].name_first):3===t.length?this.translations.and_x_other.replace("%s",e).replace("%d",1):this.translations.and_x_others.replace("%s",e).replace("%d",t.length-2)}return e},onToggle:function(t){t.preventDefault(),t.stopPropagation(),this.toggle()},onSelect:function(t){t.preventDefault(),t.stopPropagation(),this.select((0,d.default)(t.currentTarget).data("id"))},onRemove:function(t){t.preventDefault(),t.stopPropagation(),this.remove([(0,d.default)(t.currentTarget).data("id")],!0),this.updateCounter()}})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(t,e,s){"use strict";var i,n,a;t("./chat-input"),i=jQuery,n=_,a=peepso,window.PsChatWindow=function(a,t,o){var e=2e3,s=3e3;function i(t,e){e||(e={});this.id=t;this.oldestMessageId=false;this.newestMessageId=false;this.deletedMessageIds=[];this.caption=null;this.input=new PsChatInput;this.disabled=e.disabled||false;this.muted=e.muted||false;this.send_receipt=e.send_receipt||false;this.receipt=e.receipt||false;this.receipt_unread=e.receipt_unread||false;this.create();this.checkStatus()}return o.npm.objectAssign(i.prototype,o.npm.EventEmitter.prototype,{template:peepsochatdata.windowTemplate,messageTemplate:peepsochatdata.sendMessageTemplate,photosTemplate:peepsochatdata.sendPhotosTemplate,translations:peepsochatdata.translations,messageUrl:peepsochatdata.messageUrl,create:function(){this.$el=a(this.template.replace(/\{id\}/g,this.id)),this.$header=this.$el.find(".ps-chat-window-header"),this.$status=this.$el.find(".ps-chat-status"),this.$notif=this.$header.find(".ps-chat-window-notif"),this.$caption=this.$header.find("span.ps-chat-window-caption"),this.$dropdown=this.$el.find(".ps-chat-window-dropdown"),this.$turnoff=this.$el.find(".ps-chat-window-turned-off"),this.$muted=this.$el.find(".ps-chat-window-muted"),this.$content=this.$el.find(".ps-chat-window-content"),this.$messages=this.$el.find(".ps-chat-window-messages"),this.$tmpchat=this.$el.find(".ps-chat-window-tmpchat"),this.$typing=this.$el.find(".ps-chat-window-typing"),this.$btnOption=this.$el.find(".ps-chat-options").hide(),this.$el.find(".ps-chat-window-input").append(this.input.$el),this.$el.on("click",".ps-chat-window-header",a.proxy(function(t){t.preventDefault(),t.stopPropagation(),this.toggle(!0)},this)),this.$content.on("click",".ps-conversation-content",function(t){t.stopPropagation()}),this.$content.on("click",a.proxy(function(t){this.focus()},this)),this.$el.on("click",".ps-chat-options",a.proxy(this.onOptions,this)),this.$el.on("click",".ps-chat-disable",a.proxy(this.onDisable,this)),this.$el.on("click",".ps-chat-mute",a.proxy(this.onMute,this)),this.$el.on("click",".ps-chat-fullscreen",a.proxy(this.onFullScreen,this)),this.$el.on("click",".ps-chat-blockuser",a.proxy(this.onBlockUser,this)),this.$el.on("click",".ps-chat-close",a.proxy(this.onClose,this)),this.$el.on("click",".ps-chat-checkmark",a.proxy(this.onToggleNotification,this)),this.expanded=!1,this.loadInitialMessages(),this.$caption.on("click","a",a.proxy(function(t){this.expanded?t.stopPropagation():t.preventDefault()},this)),this.updateDisabled(),this.updateMuted(),o.observer.addAction("msgso_send_message",a.proxy(this.send,this),10,3)},loadInitialMessages:function(){this.loadNewerLock=!0,this.loadNewerCount||(this.loadNewerCount=0),this.loadMessages({msg_id:this.id,chat:1,get_messages:1,get_participants:1},function(t){t.success&&(this.renderConversation(t.data),this.updateCheckmark(),this.scrollTo("bottom"),this.expanded||(this.scrollOnExpand=!0),this.input.on("submit",a.proxy(this.onInputSubmit,this)),this.input.on("click",a.proxy(this.onInputFocus,this)),this.input.on("focus",a.proxy(this.onInputFocus,this)),this.input.on("blur",a.proxy(this.onInputBlur,this)),this.input.on("change",a.proxy(this.onInputChange,this)),this.input.on("photos_added",a.proxy(this.onInputAddPhotos,this)),this.input.on("photos_cancel",a.proxy(this.onInputCancelAddPhotos,this)),this.loadNewerLock=!1,this.loadNewerQueue&&this.expanded&&(this.loadNewerQueue=!1,this.loadNewerMessages()),this.$content.bind("mousewheel",a.proxy(function(t,e){var s=a(t.currentTarget);0<e&&0===s.scrollTop()?(t.preventDefault(),this.loadOlderMessages()):e<0&&s.scrollTop()==s.get(0).scrollHeight-s.innerHeight()&&t.preventDefault()},this)))})},send:function(s,i,n){return a.Deferred(a.proxy(function(e){if((s=+s)===+this.id)if(i=a.trim(i),n=n||{},i||n.type){var t=a.extend({},{content:i,id:peepsodata.currentuserid,uid:peepsodata.userid,type:"activity",parent_id:s},n);o.disableAuth().disableError().postJson("messagesajax.add_message",t,a.proxy(function(t){t.success&&(this.loadNewerMessages(),e.resolve())},this))}else e.reject();else e.reject()},this))},loadNewerMessages:function(){this.loadNewerLock?this.loadNewerQueue=!0:(this.loadNewerLock=!0,this.loadNewerCount||(this.loadNewerCount=0),this.loadMessages({msg_id:this.id,chat:1,get_messages:1,get_participants:++this.loadNewerCount%10==0?1:0,get_recently_deleted:1,direction:"new",from_id:this.newestMessageId},function(t){this.renderConversation(t.data,"append"),this.scrollTo("bottom"),this.loadNewerLock=!1,this.tmpNotEmpty&&(this.$tmpchat.empty(),this.tmpNotEmpty=!1),this.loadNewerQueue&&(this.loadNewerQueue=!1,this.loadNewerMessages())}))},loadOlderMessages:function(){this.loadOlderLock||(this.loadOlderLock=!0,this.loadMessages({msg_id:this.id,chat:1,get_messages:1,get_participants:0,get_recently_deleted:0,direction:"old",from_id:this.oldestMessageId},function(t){this.renderConversation(t.data,"prepend"),this.updateCheckmark(),this.scrollTo("top"),this.loadOlderLock=!1}))},loadMessages:function(t,e){this.loadMessagesXHR&&this.loadMessagesXHR.ret.abort(),this.loadMessagesXHR=o.disableAuth().disableError().postJson("messagesajax.get_messages_in_conversation",t,a.proxy(function(t){a.proxy(e,this)(t),this.loadMessagesXHR=!1},this))},checkStatus:function(){var t={msg_id:this.id,chat:1,get_messages:0,get_participants:1,get_recently_deleted:0};clearInterval(this.checkStatusTimer),this.checkStatusTimer=setInterval(a.proxy(function(){this.checkStatusXHR&&this.checkStatusXHR.ret.abort(),this.checkStatusXHR=o.disableAuth().disableError().postJson("messagesajax.get_messages_in_conversation",t,a.proxy(function(t){this.renderConversation(t.data),this.checkStatusXHR=!1},this))},this),6e4)},renderConversation:function(t,e){var s;if(t.users&&t.users.length){this.caption=this.formatParticipants(t.users),this.$caption.html(this.caption||"&nbsp;"),this.$status.children().get(0).className=this.isOnline(t.users)?"ps-icon-circle":"ps-icon-clock";var i=this.$dropdown.find(".ps-chat-blockuser");1<t.users.length?i.hide():(i.show(),i.data("user-id",t.users[0].id))}if(t.ids&&t.ids.length&&t.html){var n=o.observer.applyFilters("messages_render",a(t.html));o.observer.doAction("peepso_external_link",n),"prepend"===e?(this.oldestMessageId=+t.ids[0],this.$messages.prepend(n)):"append"===e?(this.newestMessageId=+t.ids[t.ids.length-1],this.$messages.append(n)):(this.oldestMessageId=+t.ids[0],this.newestMessageId=+t.ids[t.ids.length-1],this.$messages.html(n))}if(t.recently_deleted&&t.recently_deleted.length)for(;t.recently_deleted.length;)s=+t.recently_deleted.shift(),-1===this.deletedMessageIds.indexOf(s)&&(this.deletedMessageIds.push(s),this.$messages.find(".ps-js-message-"+s).remove(),s===this.newestMessageId?this.newestMessageId=+this.$messages.find(".ps-js-message").last().data("id"):s===this.oldestMessageId&&(this.oldestMessageId=+this.$messages.find(".ps-js-message").first().data("id")));this.renderTyping(t.currently_typing)},renderTyping:function(t){this.$typing.html(t||""),clearTimeout(this.renderTypingTimer),this.renderTypingTimer=setTimeout(a.proxy(function(){this.$typing.html("")},this),5e3)},markAsRead:t.throttle(function(){o.disableAuth().disableError().postJson("messagesajax.mark_read_messages_in_conversation",{msg_id:this.id},function(){o.observer.applyFilters("pschat_mark_as_read")})},2e3),iAmTyping:t.throttle(function(){o.disableAuth().disableError().postJson("messagesajax.i_am_typing",{msg_id:this.id})},+peepsodata.notification_ajax_delay_min||5e3),focus:t.debounce(function(){this.input.focus()},100),update:function(t){var e=+(t=t||{}).unread||0;this.unread||(this.unread=0),this.unread!==e?(this.unread=e,this.expanded?this.loadNewerMessages():this.disabled||(this.unread?this.$notif.html(this.unread).show():this.$notif.hide())):this.last_activity!==t.last_activity&&(this.last_activity=t.last_activity,this.loadNewerMessages()),this.disabled!==t.disabled&&(this.disabled=t.disabled,this.updateDisabled()),this.muted!==t.muted&&(this.muted=t.muted,this.updateMuted()),this.send_receipt!==t.send_receipt&&(this.send_receipt=t.send_receipt,this.updateNotification()),this.receipt===t.receipt&&this.receipt_unread===t.receipt_unread||(this.receipt=t.receipt,this.receipt_unread=t.receipt_unread,this.receipt&&this.updateCheckmark())},toggle:function(t){this.expanded?this.collapse(t):this.expand(t)},expand:function(t){this.expanded||(this.$el.addClass("ps-chat-window-open"),this.$btnOption.show(),this.expanded=!0,this.focus(),0<this.unread&&(this.loadNewerMessages(),this.unread=0,this.$notif.hide()),this.scrollOnExpand&&(this.scrollTo("bottom"),this.scrollOnExpand=!1),t&&this.emit("expand",this.id))},collapse:function(t){this.expanded&&(this.$el.removeClass("ps-chat-window-open"),this.$btnOption.hide(),this.expanded=!1,t&&this.emit("collapse",this.id))},destroy:function(t){this.$el.remove(),t&&this.emit("destroy",this.id),this.removeAllListeners()},formatParticipants:function(t){var e;if(1===t.length)e='<a href="'+t[0].url+'">'+t[0].name_full+"</a>";else if(1<t.length){e=[];for(var s=0,i=Math.min(2,t.length-1);s<i;s++)e.push(t[s].name_first);e=e.join(", "),e=2===t.length?this.translations.and.replace(/%s(.+)%s/,e+"$1"+t[t.length-1].name_first):3===t.length?this.translations.and_x_other.replace("%s",e).replace("%d",1):this.translations.and_x_others.replace("%s",e).replace("%d",t.length-2),e='<a href="'+this.messageUrl.replace("{id}",this.id)+'">'+e+"</a>"}return e},isOnline:function(t){var e=!1;if(t&&t.length)for(var s=0;s<t.length;s++)if(t[s].online){e=!0;break}return e},scrollTo:function(t){this.$content[0].scrollTop="top"===t?0:this.$content[0].scrollHeight},toggleDisable:t.debounce(function(){var e={msg_id:this.id,disabled:this.disabled?0:1};this.$el.find(".ps-chat-disable img").show(),o.disableAuth().disableError().postJson("chatajax.set_chat_disabled",e,a.proxy(function(t){this.$el.find(".ps-chat-disable img").hide(),t.success&&(this.disabled=e.disabled,this.updateDisabled(),this.updateMuted(),this.toggleDropdown("hide"))},this))},400),updateDisabled:function(){var t;this.disabled?(t=this.translations.turn_on_chat,this.$el.removeClass("active"),this.$turnoff.show(),this.$notif.hide()):(t=this.translations.turn_off_chat,this.$turnoff.hide()),this.$el.find(".ps-chat-disable span").html(t)},toggleMute:t.debounce(function(){if(!this.muted)return this.toggleDropdown("hide"),void ps_messages.mute_conversation(this.id);var e={parent_id:this.id,mute:this.muted?0:1};this.$el.find(".ps-chat-mute img").show(),o.disableAuth().disableError().postJson("messagesajax.set_mute",e,a.proxy(function(t){this.$el.find(".ps-chat-mute img").hide(),t.success&&(o.observer.applyFilters("psmessages_conversation_"+(e.mute?"mute":"unmute"),e.parent_id),this.toggleDropdown("hide"))},this))},400),updateMuted:function(){var t=this.muted?this.translations.unmute_chat:this.translations.mute_chat;this.muted&&!this.disabled?(this.$el.removeClass("active"),this.$muted.show(),this.$notif.hide()):this.$muted.hide(),this.$el.find(".ps-chat-mute span").html(t)},toggleBlockUser:t.debounce(function(t){confirm(peepsomessagesdata.blockuser_confirm_text)&&(this.destroy(!0),ps_member.block_user(t))},400),toggleNotification:t.debounce(function(){var e={msg_id:this.id,read_notif:this.send_receipt?0:1};this.$el.find(".ps-chat-checkmark img").show(),o.disableAuth().disableError().postJson("chatajax.set_chat_read_notification",e,a.proxy(function(t){this.$el.find(".ps-chat-checkmark img").hide(),t.success&&(this.send_receipt=e.read_notif,this.updateNotification(),this.toggleDropdown("hide"))},this))},400),updateNotification:function(){this.$el.find(".ps-chat-checkmark").find("span").html(this.send_receipt?this.translations.hide_checkmark:this.translations.show_checkmark)},updateCheckmark:t.throttle(function(){var t;this.receipt&&(t=this.$messages.find(".ps-icon-ok").addClass("read"),0<this.receipt_unread&&t.slice(0-this.receipt_unread).removeClass("read"))},1e3),toggleDropdown:function(t){"hide"===t?(this.$dropdown.hide(),this.$btnOption.removeClass("ps-chat-icon-on")):(this.$dropdown.show(),this.$btnOption.addClass("ps-chat-icon-on"))},onOptions:function(t){t.preventDefault(),t.stopPropagation(),this.$dropdown.is(":visible")?this.toggleDropdown("hide"):this.toggleDropdown("show")},onDisable:function(t){t.preventDefault(),t.stopPropagation(),this.toggleDisable()},onMute:function(t){t.preventDefault(),t.stopPropagation(),this.toggleMute()},onFullScreen:function(t){t.preventDefault(),t.stopPropagation(),window.location=this.messageUrl.replace("{id}",this.id)},onBlockUser:function(t){t.preventDefault(),t.stopPropagation();var e=a(t.currentTarget).data();+e.userId&&this.toggleBlockUser(+e.userId)},onClose:function(t){t.preventDefault(),t.stopPropagation(),this.destroy(!0)},onToggleNotification:function(t){t.preventDefault(),t.stopPropagation(),this.toggleNotification()},onInputSubmit:function(t,e){if(e=e||{},(t=a.trim(t))||e.type){var s=a.extend({},{content:t,id:peepsodata.currentuserid,uid:peepsodata.userid,type:"activity",parent_id:this.id},e);"activity"===s.type&&(this.tmpNotEmpty=!0,this.$tmpchat.append(this.messageTemplate.replace("{content}",t)),this.scrollTo("bottom")),o.disableAsync().disableAuth().disableError().postJson("messagesajax.add_message",s,a.proxy(function(t){t.success&&this.loadNewerMessages()},this))}},onInputFocus:function(t){t.stopPropagation(),this.markAsRead(),this.disabled||this.$el.addClass("active")},onInputBlur:function(t){t.stopPropagation(),this.$el.removeClass("active"),this.toggleDropdown("hide")},onInputChange:function(){this.iAmTyping()},onInputAddPhotos:function(t,e){var s,i=/\{item\}([\s\S]+)\{\/item\}/,n=this.photosTemplate.match(i)[1],a="";for(s=1;s<=t;s++)a+=n;this.tmpNotEmpty=!0,this.$tmpchat.append(this.photosTemplate.replace("{id}",e).replace(i,a)),this.scrollTo("bottom")},onInputCancelAddPhotos:function(t){this.$tmpchat.find(".my-message-photos-"+t).remove()}}),i}(i,n,a)},{"./chat-input":1}],4:[function(t,e,s){"use strict";t("./chat-window");var i,u=(i=t("./chat-sidebar"))&&i.__esModule?i:{default:i};!function(s,t,i){window.PsChat=null,window.ps_chat={},window.ps_chat.open_chat=function(t){var e=window.peepsochatdata.messageUrl.replace("{id}",t);s(document.body).hasClass("wp-admin")?window.open(e):window.location=e};/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent)||setTimeout(function(){PsChat=function(o,e,i){var t=+peepsodata.sse,h=4,s=+peepsodata.notification_ajax_delay_min,n=+peepsodata.notification_ajax_delay;function a(t){t=t.split(/\r?\n/);t=e.map(t,function(t){return o.trim(t)});t=e.filter(t,function(t){return t.length});return t}var d=window.peepsomessagesdata||{},r=+d.chat_restriction_mode||0,c=a(d.chat_disable_on_pages||""),p=a(d.chat_enable_on_pages||"");function l(){var t=window.location.pathname,e=+peepsodata.currentuserid,s=r,i=1===s?p:c,n;if(!e){this.disabled=true;return false}this.disabled=1===s?true:false;if(i.length){for(n=0;n<i.length;n++){try{if(t.match(new RegExp("^"+i[n]+"(#|\\?|\\/|$)"))){this.disabled=!this.disabled;break}}catch(t){}}}if(this.disabled){return false}this.state={};this.beforeDestroyState={};this.windows={};this.windowsOrder=[];this.windowsUpdate={};this.sidebar=new u.default;this.create()}return i.npm.objectAssign(l.prototype,{template:peepsochatdata.containerTemplate,create:function(){this.$root=o(this.template),this.$wrapper=this.$root.children(".ps-chat-wrapper"),this.$windows=this.$wrapper.children(".ps-chat-windows"),this.$wrapper.append(this.sidebar.$el),this.$root.appendTo(document.body),this.sidebar.on("select",o.proxy(this.onSidebarSelect,this)),this.sidebar.on("remove",o.proxy(this.onSidebarRemove,this)),o(window).off("resize.ps-chat").on("resize.ps-chat",o.proxy(this.onDocumentResize,this)),setTimeout(o.proxy(function(){t?this.fetchChatState():(this.onDocumentResize(),+peepsomessagesdata.get_chats_longpoll&&setInterval(o.proxy(function(){this.startLongPolling()},this),3e4))},this),3e3),i.observer.addAction("peepso_sse",o.proxy(function(t){"get_chats"===t.event&&this.fetchChatState()},this),10,1),i.observer.addAction("browser.inactive",o.proxy(function(){this.browserInactive=!0},this)),i.observer.addAction("browser.active",o.proxy(function(){this.browserInactive=!1,this.checkChatDelay=s,this.stopLongPolling(),this.startLongPolling()},this))},startLongPolling:function(){t||(this.stopLongPolling(),this.fetchChatState().done(o.proxy(function(){this.checkChatState()},this)))},stopLongPolling:function(){t||(clearTimeout(this.checkChatTimer),this.checkChatXHR&&this.checkChatXHR.abort(),this.fetchChatXHR&&this.fetchChatXHR.ret&&this.fetchChatXHR.ret.abort(),this.checkChatXHR=!1,this.fetchChatXHR=!1)},checkChatState:function(){this.checkChatXHR=o.post({url:peepsodata.ajaxurl,dataType:"json",data:{action:"peepso_should_get_chats",delay:this.checkChatDelay}}),this.checkChatXHR.always(o.proxy(function(t){var e,s;e=+(t=t||[])[1],s=+t[0],this.checkChatDelay=e||this.checkChatDelay,s?this.fetchChatState().always(o.proxy(function(){this.checkChatDelayed(e)},this)):this.checkChatDelayed(e)},this))},checkChatDelayed:function(t){t=t||s,this.browserInactive&&(t=n),this.checkChatTimer=setTimeout(o.proxy(this.checkChatState,this),t)},fetchChatState:function(){return this.fetchChatXHR?o.Deferred(o.proxy(function(t){t.resolveWith(this)},this)):(this.fetchChatXHR=i.disableAuth().disableError().postJson("chatajax.get_chats",{},o.proxy(function(t){var e,s;if(t.success){for(this.windowsOrder=[],s=0;s<t.data.chats.length;s++)e=t.data.chats[s],this.state[e.id]=this.state[e.id]||{},this.windowsOrder.push(+e.id),this.state[e.id].last_activity===e.last_activity&&this.state[e.id].muted===+e.muted&&this.state[e.id].disabled===+e.disabled&&this.state[e.id].send_receipt===+e.send_receipt&&this.state[e.id].receipt===+e.receipt&&this.state[e.id].receipt_unread===+e.receipt_unread||(!this.state[e.id].last_activity&&h<=s?this.windowsUpdate[e.id]=!1:this.windowsUpdate[e.id]=!0),o.extend(this.state[e.id],{state:e.state,unread:e.unread,last_activity:e.last_activity,disabled:+e.disabled,muted:+e.muted,send_receipt:+e.send_receipt,receipt:+e.receipt,receipt_unread:+e.receipt_unread});this.renderWindows()}this.fetchChatXHR=!1},this)),this.fetchChatXHR.ret)},getChatState:function(){var t,e,s,i=[];for(s=0;s<this.windowsOrder.length;s++)e=this.windowsOrder[s],t=this.state[e]||{},i.push({id:e,state:t.state||void 0,unread:t.unread||void 0,last_activity:t.last_activity||void 0});return i},setChatState:function(t,e){var s;this.stopLongPolling(),this.state[t]=o.extend(this.state[t]||{},e),s=JSON.stringify(this.getChatState()),this.setChatStateXHR&&this.setChatStateXHR.ret.abort(),this.setChatStateXHR=i.disableAuth().disableError().postJson("chatajax.set_chats",{chats:s},o.proxy(function(){this.setChatStateXHR=!1,this.startLongPolling()},this))},renderWindows:function(){var t,e,s,i,n=this.windowsOrder.slice(h),a=this.windowsOrder.slice(0,h);for(t in this.windows)-1===a.indexOf(+this.windows[t].id)&&(this.windows[t].destroy(),delete this.windows[t]);for(i=0;i<a.length;i++)t=a[i],this.windows[t]||(this.windows[t]=this.createWindow(t),this.windows[t].$el.appendTo(this.$windows));for(i=0;i<a.length;i++)t=a[i],e=+this.state[t].state,s=this.windows[t].$el[0],i!==this.getWindowIndex(s)&&(0===i?s.prependTo(this.$windows):s.insertBefore(this.$windows.children().eq(i))),1==e?this.windows[t].expand():this.windows[t].collapse(),this.windowsUpdate[t]&&(this.windows[t].update(this.state[t]),this.windowsUpdate[t]=!1);this.sidebar.reset(n,this.windowsUpdate),this.windowsOrder.length?this.backspacePrevented||(this.backspacePrevented=!0,o(document).on("keydown.ps-chat",function(t){8!==t.which||o(t.target).is("input, textarea")||t.preventDefault()})):this.backspacePrevented&&(this.backspacePrevented=!1,o(document).off("keydown.ps-chat"))},createWindow:function(t){var e=new PsChatWindow(t,this.state[t]);return e.on("expand",o.proxy(this.onWindowExpand,this)),e.on("collapse",o.proxy(this.onWindowCollapse,this)),e.on("destroy",o.proxy(this.onWindowDestroy,this)),e},getWindowIndex:function(t){var e;if(o.contains(document.documentElement,t))for(e=0;t=t.previousSibling;e++);return e},openChat:function(t){var e;t=+t,-1===(e=this.windowsOrder.indexOf(t))?(this.windows[t]=this.createWindow(t),this.windows[t].$el.show(),this.windows[t].$el.appendTo(this.$windows),this.windowsOrder.splice(h-1,0,t)):e<h?(this.windows[t].$el.show(),this.windows[t].expand()):(this.windows[t]||(this.windows[t]=this.createWindow(t)),this.windows[t].$el.show(),this.windows[t].$el.appendTo(this.$windows),this.windowsOrder.splice(e,1),this.windowsOrder.splice(h-1,0,t)),this.windows[t].focus(),this.windows[t].markAsRead(),this.setChatState(t,{state:1}),this.beforeDestroyState[t]&&(this.state[t].disabled=this.beforeDestroyState[t].disabled,this.state[t].muted=this.beforeDestroyState[t].muted,this.state[t].send_receipt=this.beforeDestroyState[t].send_receipt),this.windowsUpdate[t]=!0,this.renderWindows()},closeChat:function(t){var e;this.beforeDestroyState[t]=this.state[t],this.windows[t]&&this.windows[t].destroy(),delete this.windows[t],delete this.state[t],-1<(e=this.windowsOrder.indexOf(+t))&&this.windowsOrder.splice(e,1)},isDisabled:function(){return this.disabled},onWindowExpand:function(t){this.setChatState(t,{state:1})},onWindowCollapse:function(t){this.setChatState(t,{state:2})},onWindowDestroy:function(t){this.beforeDestroyState[t]=this.state[t],this.setChatState(t,{state:0}),delete this.windows[t],delete this.state[t];var e=this.windowsOrder.indexOf(+t);-1<e&&this.windowsOrder.splice(e,1),(t=this.sidebar.removeFirst())&&(this.windows[t]||(this.windows[t]=this.createWindow(t)),this.windows[t].$el.show(),this.windows[t].$el.appendTo(this.$windows),this.windows[t].expand())},onSidebarSelect:function(t){this.openChat(t)},onSidebarRemove:function(t){if(t&&t.length)for(var e=0;e<t.length;e++)this.setChatState(t[e],{state:0})},onDocumentResize:e.debounce(function(){var t=this.$windows.width(),e=Math.floor(t/246);this._prevWidth!==t&&(this._prevWidth=t,this.stopLongPolling(),1<=e?(h=e,this.renderWindows(),this.startLongPolling(),this.$root.show()):this.$root.hide())},500)}),l}(s,t,i);var e=new PsChat;e.isDisabled()||(ps_chat.open_chat=function(t){e.openChat(t)})},100)}(jQuery||$,_,peepso)},{"./chat-sidebar":2,"./chat-window":3}],5:[function(t,e,s){"use strict";t("./chat")},{"./chat":4}]},{},[5]);