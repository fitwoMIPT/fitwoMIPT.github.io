!function(){var t=function(o,t){return peepso.createClass(o,{__constructor:function(){this.canSubmitFlag=false;this.dropzone=null},set_postbox:function(o){this.$postbox=o;this.$posttab=o.$posttabs},init:function(){this.initialize()},initialize:function(){this.$text=this.$postbox.$textarea;this.$textContainer=this.$text.closest(".ps-postbox-status");var o=this.$postbox.find(".ps-postbox-tabs").children("[data-tab-id=photos]");this.$uploadButton=o.find(".ps-postbox-photo-upload");this.$uploadPreview=o.find(".ps-postbox-preview");this.$posttab.on("peepso_posttabs_show-photos",t.proxy(this.show,this));this.$posttab.on("peepso_posttabs_cancel-photos",t.proxy(this.cancel,this));this.$posttab.on("peepso_posttabs_submit-photos",t.proxy(this.post,this));peepso.observer.addAction("postbox_type_set",t.proxy(function(o,t){if(o===this.$postbox&&t==="photos"){this.$phototab.trigger("click")}},this),10,2);this.$uploadButton.on("click",t.proxy(this.upload,this));this.$phototab=this.$postbox.find("#photo-post");this.$phototab.on("click",t.proxy(this.onCameraTabClick,this));this.placeholderDefault=this.$text.attr("placeholder");this.placeholderPhoto=t("#photo-comment-label").text();peepso.observer.addFilter("peepso_postbox_can_submit",t.proxy(this.canSubmit,this),20,1);peepso.observer.addAction("psmessage_new_message_close",t.proxy(function(o){this.dropzone.empty()},this),10,1);peepso.observer.addAction("postbox_group_set",t.proxy(function(o,t){if(this.$postbox===o){this.groupId=t;this.dropzone.empty()}},this),10,2);peepso.observer.addAction("postbox_group_reset",t.proxy(function(o,t){if(this.$postbox===o){this.groupId=undefined;this.dropzone.empty()}},this),10,2);peepso.observer.addFilter("photos_validate_req",t.proxy(function(o,t){if(this.dropzone===t&&this.groupId){o.group_id=this.groupId;o.module_id=window.peepsogroupsdata&&peepsogroupsdata.module_id}return o},this),10,2);peepso.observer.addFilter("photos_upload_req",t.proxy(function(o,t){if(this.dropzone===t&&this.groupId){o.group_id=this.groupId;o.module_id=window.peepsogroupsdata&&peepsogroupsdata.module_id}return o},this),10,2)},show:function(o,t){t.show();this.showButton();this.$phototab.addClass("active");this.$text.attr("placeholder",this.placeholderPhoto);this.dropzoneInit()},showButton:function(){this.$uploadPreview.hide();this.$textContainer.hide();this.$uploadButton.show()},showPreview:function(){this.$uploadButton.hide();this.$uploadPreview.show();this.$textContainer.show();this.$text.focus()},upload:function(){this.dropzone.triggerUpload()},cancel:function(){this.dropzone.empty();this.showButton();this.$phototab.removeClass("active");this.$text.attr("placeholder",this.placeholderDefault)},post:function(){var o="postbox_req_"+this.$postbox.guid;peepso.observer.addFilter(o,this.postSetRequest,10,1,this);this.$postbox.save_post();peepso.observer.removeFilter(o,this.postSetRequest,10);this.dropzone.empty("save")},postSetRequest:function(o){return t.extend(o,{files:this.dropzone.getPhotos(),type:"photo"})},canSubmit:function(o){if(this.$posttab.current_tab_id==="photos"){o.hard.push(this.canSubmitFlag)}return o},dropzoneInit:function(){if(!this.dropzone){this.dropzone=new peepso.PhotoDropzone(this.$uploadPreview);this.dropzone.on("photo_added",t.proxy(this.dropzonePhotoAdded,this));this.dropzone.on("photo_upload_start",t.proxy(this.dropzonePhotoUploadStart,this));this.dropzone.on("photo_upload_done",t.proxy(this.dropzonePhotoUploadDone,this));this.dropzone.on("photo_empty",t.proxy(this.dropzonePhotoEmpty,this));this.dropzone.addDroppable(this.$uploadButton[0])}},dropzonePhotoAdded:function(){this.showPreview()},dropzonePhotoUploadStart:function(){this.canSubmitFlag=false},dropzonePhotoUploadDone:function(o){if(o<=0){this.canSubmitFlag=true;this.$postbox.on_change()}},dropzonePhotoEmpty:function(){this.canSubmitFlag=false;this.showButton()},onCameraTabClick:function(){if(this.$posttab.current_tab_id!=="photos"){this.$postbox.find("[data-tab=photos]").trigger("click")}}})}("PsPostboxPhoto",jQuery);peepso.observer.addFilter("peepso_postbox_addons",function(o){return o.push(new t),o},10,1),peepso.observer.addAction("postbox_init",function(o){o.$tabContext.find("#photo-post").remove()},10,1)}();